很多同学肯定在项目中遇到这样的需求，触发某一个事件之后在指定的时间后触发其它事件。比如说用户下单之后，如果超过30分支关闭订单；或者下单使用了促销，促销活动在指定的时间过期了如若未付款需要关闭订单。 解决这样的问题，我们通常的做法是加一个job来做这件事情，设置job每隔几分钟跑一次把需要处理的数据线查询出来，然后再去执行。这种解决办法自然是最简单又可靠的，只要job和DB正常运行不会存在漏掉任何任务。这种方法针对不同的使用场景也存在问题，job过快数据库压力大，job慢了业务上不能精确的处理。

![](https://github.com/moxingwang/collection/blob/master/resources/image/%E6%B6%88%E6%81%AF%E5%BB%B6%E8%BF%9F%E6%94%B9%E9%80%A0%E5%89%8D.jpg?raw=true)

本人的项目中最近刚刚改造过一个这样的场景，顺便记录下来。项目初期业务简单粗暴用户下单后订单未付款订单30分钟关闭，使用了促销的订单，每次在支付的时候去验单必须验证促销活动信息，如果活动过期拦截终止支付请求并且关闭订单，显然这么做用户体验不好。本次改动方向简单（减少数据库查询，业务上更加精确），解决思路同样简单使用延迟消息。

# 常见的几种延迟消息

# 本次改造

# 参考
* [基于redis的延迟消息队列设计](https://www.cnblogs.com/peachyy/p/7398430.html)
* [如何在MQ中实现支持任意延迟的消息](https://www.cnblogs.com/luckcs/articles/8202380.html)